<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ጓደኛ (buddy) : Your Ideal Friend</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0b141c;
            color: #e2e8f0;
        }

        @keyframes slideInUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        .animate-slideInUp {
            animation: slideInUp 0.8s ease-out forwards;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        .animate-fadeIn {
            animation: fadeIn 1.2s ease-out forwards;
        }

        @keyframes fadeInRight {
            from {
                transform: translateX(-20px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        .animate-fadeInRight {
            animation: fadeInRight 0.5s ease-out forwards;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #1f2937;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #4f46e5;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #6366f1;
        }
    </style>
</head>
<body class="text-white">
    <div class="relative min-h-screen flex flex-col justify-center items-center py-10 px-4 sm:px-6 lg:px-8">
        
        <div class="absolute inset-0 z-0 overflow-hidden">
            <div class="absolute -top-40 -left-40 w-96 h-96 bg-blue-700 rounded-full mix-blend-multiply filter blur-2xl opacity-30 animate-blob animation-delay-2000"></div>
            <div class="absolute -bottom-20 -right-20 w-80 h-80 bg-purple-700 rounded-full mix-blend-multiply filter blur-2xl opacity-30 animate-blob animation-delay-4000"></div>
            <div class="absolute inset-0 bg-gradient-to-br from-blue-900 via-transparent to-indigo-900 opacity-20"></div>
        </div>

        <main class="relative z-10 w-full max-w-7xl mx-auto space-y-20">
            
            <section id="auth-section" class="text-center py-16 px-4 sm:px-6 lg:px-8 animate-fadeIn">
                <div class="max-w-md mx-auto bg-gray-800 bg-opacity-70 backdrop-filter backdrop-blur-lg p-8 rounded-3xl shadow-2xl border border-gray-700/50">
                    <h1 class="text-4xl sm:text-5xl lg:text-6xl font-extrabold leading-tight mb-4 animate-slideInUp" style="animation-delay: 0.1s;">
                        Welcome to <span class="text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-500">ጓደኛ </span>
                    </h1>
                    <p class="text-base sm:text-lg lg:text-xl text-gray-300 mb-8 animate-slideInUp" style="animation-delay: 0.3s;">
                        Your imaginary friend is waiting!
                    </p>
                    <div class="space-y-4 animate-slideInUp" style="animation-delay: 0.5s;">
                        <button id="show-login" class="w-full bg-gradient-to-r from-teal-500 to-blue-600 hover:from-teal-600 hover:to-blue-700 text-white font-semibold py-3 px-8 rounded-full shadow-lg transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-teal-500 focus:ring-opacity-50">
                            Login
                        </button>
                        <button id="show-signup" class="w-full bg-gray-700/60 border border-gray-600 hover:bg-gray-700 text-gray-100 font-semibold py-3 px-8 rounded-full transition-all duration-200 focus:outline-none focus:ring-4 focus:ring-gray-600 focus:ring-opacity-50">
                            Signup
                        </button>
                    </div>
                </div>
            </section>

            <section id="login-section" class="hidden">
                <div class="max-w-md mx-auto bg-gray-800 bg-opacity-70 backdrop-filter backdrop-blur-lg p-8 rounded-3xl shadow-2xl border border-gray-700/50 relative">
                    <button id="back-to-auth-login" class="absolute top-4 left-4 text-gray-400 hover:text-white transition-colors duration-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                        </svg>
                    </button>
                    <h2 class="text-3xl font-bold text-center mb-6 text-gray-100 mt-6">Login</h2>
                    <form id="login-form" class="space-y-6">
                        <input type="email" id="login-email" placeholder="Email" class="w-full bg-gray-700/60 border border-gray-600 rounded-xl p-4 text-gray-100 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
                        <input type="password" id="login-password" placeholder="Password" class="w-full bg-gray-700/60 border border-gray-600 rounded-xl p-4 text-gray-100 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
                        <button type="submit" class="w-full bg-gradient-to-r from-teal-500 to-blue-600 hover:from-teal-600 hover:to-blue-700 text-white font-semibold py-3 px-8 rounded-full shadow-lg transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-teal-500 focus:ring-opacity-50">
                            Login
                        </button>
                    </form>
                </div>
            </section>

            <section id="signup-section" class="hidden">
                <div class="max-w-md mx-auto bg-gray-800 bg-opacity-70 backdrop-filter backdrop-blur-lg p-8 rounded-3xl shadow-2xl border border-gray-700/50 relative">
                    <button id="back-to-auth-signup" class="absolute top-4 left-4 text-gray-400 hover:text-white transition-colors duration-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                        </svg>
                    </button>
                    <h2 class="text-3xl font-bold text-center mb-6 text-gray-100 mt-6">Signup</h2>
                    <form id="signup-form" class="space-y-6">
                        <input type="text" id="signup-username" placeholder="Username" class="w-full bg-gray-700/60 border border-gray-600 rounded-xl p-4 text-gray-100 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
                        <input type="email" id="signup-email" placeholder="Email" class="w-full bg-gray-700/60 border border-gray-600 rounded-xl p-4 text-gray-100 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
                        <input type="password" id="signup-password" placeholder="Password" class="w-full bg-gray-700/60 border border-gray-600 rounded-xl p-4 text-gray-100 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
                        <button type="submit" class="w-full bg-gradient-to-r from-teal-500 to-blue-600 hover:from-teal-600 hover:to-blue-700 text-white font-semibold py-3 px-8 rounded-full shadow-lg transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-teal-500 focus:ring-opacity-50">
                            Signup
                        </button>
                    </form>
                </div>
            </section>

            <section id="personality-section" class="hidden">
                <div class="max-w-3xl mx-auto bg-gray-800 bg-opacity-70 backdrop-filter backdrop-blur-lg p-8 rounded-3xl shadow-2xl border border-gray-700/50 relative">
                    <button id="back-to-login-personality" class="absolute top-4 left-4 text-gray-400 hover:text-white transition-colors duration-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                        </svg>
                    </button>
                    <h1 class="text-4xl sm:text-5xl lg:text-6xl font-extrabold leading-tight mb-4 mt-6 animate-slideInUp" style="animation-delay: 0.1s;">
                        Define Your <span class="text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-500">ጓደኛ (buddy) </span>
                    </h1>
                    <p class="text-base sm:text-lg lg:text-xl text-gray-300 mb-8 animate-slideInUp" style="animation-delay: 0.3s;">
                        Describe the ideal personality and give them a name. Your imaginary friend is waiting!
                    </p>
                    <form id="personality-form" class="space-y-6 animate-slideInUp" style="animation-delay: 0.5s;">
                        <input type="text" id="buddy-name-input" placeholder="Give your ጓደኛ (buddy) a name" class="w-full bg-gray-700/60 border border-gray-600 rounded-xl p-4 text-gray-100 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
                        <textarea id="personality-input" rows="6" placeholder="Describe their personality (e.g., 'A mischievous, curious spirit who lives in the shadows of bookshelves,a boisterous and loyal companion who loves adventure.')" class="w-full bg-gray-700/60 border border-gray-600 rounded-xl p-4 text-gray-100 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 resize-none"></textarea>
                        <button type="submit" class="w-full bg-gradient-to-r from-teal-500 to-blue-600 hover:from-teal-600 hover:to-blue-700 text-white font-semibold py-3 px-8 rounded-full shadow-lg transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-teal-500 focus:ring-opacity-50">
                            Create My ጓደኛ (Buddy)
                        </button>
                    </form>
                </div>
            </section>
            
            <section id="chat-section" class="hidden">
                <div class="max-w-3xl mx-auto bg-gray-800 bg-opacity-70 backdrop-filter backdrop-blur-lg p-8 rounded-3xl shadow-2xl border border-gray-700/50 relative">
                    <div class="flex justify-between items-center mb-6 mt-6">
                        <button id="back-to-personality-chat" class="text-gray-400 hover:text-white transition-colors duration-200">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                            </svg>
                        </button>
                        <h2 class="text-3xl font-bold text-center text-gray-100">Chat with <span id="buddy-name-display" class="text-transparent bg-clip-text bg-gradient-to-r from-teal-400 to-blue-500"></span></h2>
                        <button id="logout-button" class="bg-red-500/80 hover:bg-red-600 text-white text-sm font-medium py-1 px-4 rounded-full transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50">
                            Logout
                        </button>
                    </div>

                    <div id="chat-container" class="space-y-4 overflow-y-auto max-h-96 pr-4 custom-scrollbar">
                    </div>
                    
                    <form id="chat-form" class="mt-8 flex gap-4">
                        <input type="text" id="chat-input" placeholder="Ask your ጓደኛ anything..." class="flex-1 bg-gray-700/60 border border-gray-600 rounded-full px-5 py-3 text-gray-100 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-transparent transition-colors duration-200">
                        <button type="submit" class="bg-gradient-to-r from-teal-500 to-blue-600 text-white rounded-full p-2 w-12 h-12 flex items-center justify-center shadow-md transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-teal-500 focus:ring-opacity-50">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="22" y1="2" x2="11" y2="13"></line>
                                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                            </svg>
                        </button>
                    </form>
                </div>
            </section>
        </main>
        
        <footer class="relative z-10 text-center text-gray-500 py-10 mt-20 border-t border-gray-700 w-full max-w-7xl mx-auto">
            &copy; 2025 ጓደኛ App. All Rights Reserved.
        </footer>
    </div>
    
  <script>
    document.addEventListener('DOMContentLoaded', (event) => {
        const authSection = document.getElementById('auth-section');
        const loginSection = document.getElementById('login-section');
        const signupSection = document.getElementById('signup-section');
        const personalitySection = document.getElementById('personality-section');
        const chatSection = document.getElementById('chat-section');

        const showLoginBtn = document.getElementById('show-login');
        const showSignupBtn = document.getElementById('show-signup');
        const backToAuthLoginBtn = document.getElementById('back-to-auth-login');
        const backToAuthSignupBtn = document.getElementById('back-to-auth-signup');
        const backToLoginPersonalityBtn = document.getElementById('back-to-login-personality');
        const backToPersonalityChatBtn = document.getElementById('back-to-personality-chat'); 

        const logoutButton = document.getElementById('logout-button');

        const loginForm = document.getElementById('login-form');
        const loginEmailInput = document.getElementById('login-email'); 
        const loginPasswordInput = document.getElementById('login-password'); 

        const signupForm = document.getElementById('signup-form');
        const personalityForm = document.getElementById('personality-form');
        const chatForm = document.getElementById('chat-form');
        const chatContainer = document.getElementById('chat-container');

        const buddyNameInput = document.getElementById('buddy-name-input');
        const personalityInput = document.getElementById('personality-input');
        const buddyNameDisplay = document.getElementById('buddy-name-display');
        const chatInput = document.getElementById('chat-input');

        let idealFriendCharacteristics = "";
        let buddyName = "Buddy";
        let accessToken = null; 
        function showSection(section) {
            authSection.classList.add('hidden');
            loginSection.classList.add('hidden');
            signupSection.classList.add('hidden');
            personalitySection.classList.add('hidden');
            chatSection.classList.add('hidden');
            if (section === loginSection || section === signupSection || section === personalitySection) {
                buddyNameInput.value = '';
                personalityInput.value = '';
            }
            if (section === authSection) {
                loginEmailInput.value = '';
                loginPasswordInput.value = '';
                document.getElementById('signup-username').value = '';
                document.getElementById('signup-email').value = '';
                document.getElementById('signup-password').value = '';
            }
            
            section.classList.remove('hidden');
            section.classList.add('animate-fadeIn');
        }

        showLoginBtn.addEventListener('click', () => showSection(loginSection));
        showSignupBtn.addEventListener('click', () => showSection(signupSection));
        backToAuthLoginBtn.addEventListener('click', () => showSection(authSection));
        backToAuthSignupBtn.addEventListener('click', () => showSection(authSection));
        backToLoginPersonalityBtn.addEventListener('click', () => {
            accessToken = null;
            showSection(loginSection); 
        });
        logoutButton.addEventListener('click', handleLogout);
        backToPersonalityChatBtn.addEventListener('click', handleReturnToChat);

        signupForm.addEventListener('submit', async function(event) {
            event.preventDefault();
            const username = document.getElementById('signup-username').value;
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;

            try {
                const response = await fetch('/api/signup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, email, password }),
                });

                const data = await response.json();

                if (response.ok) {
                    accessToken = data.access_token;
                    showSection(personalitySection);
                } else {
                    alert(`Signup failed: ${data.detail || 'User or email already exists.'}`);
                }
            } catch (error) {
                console.error('Signup error:', error);
                alert('An unexpected error occurred during signup.');
            }
        });

        loginForm.addEventListener('submit', async function(event) {
            event.preventDefault();

            const email = loginEmailInput.value;
            const password = loginPasswordInput.value;

            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: 'placeholder', email, password }),
                });

                const data = await response.json();

                if (response.ok) {
                    accessToken = data.access_token;
                    buddyNameDisplay.textContent = "Buddy";
                    chatContainer.innerHTML = ''; 
                    const initialMessage = `Welcome back buddy! What's on your mind?`;
                    appendMessage(initialMessage, "Buddy"); 
                    showSection(chatSection); 

                } else {
                    alert(`Login failed: ${data.detail || 'Incorrect email or password.'}`);
                }
            } catch (error) {
                console.error('Login error:', error);
                alert('An unexpected error occurred during login.');
            }
        });
        async function handleReturnToChat() {
            if (!accessToken) {
                return showSection(personalitySection); 
            }

            try {
                const response = await fetch('/api/history', {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${accessToken}` },
                });

                const data = await response.json();
                
                if (response.ok) {
                    buddyName = data.buddy_name || "Buddy";
                    idealFriendCharacteristics = data.ideal_friend || ""; 
                    buddyNameDisplay.textContent = buddyName;
                    chatContainer.innerHTML = ''; 

                    if (data.history && data.history.length > 0) {
                        data.history.forEach(msg => {
                            const sender = msg.sender === 'human' ? 'You' : buddyName;
                            appendMessage(msg.content, sender, true); 
                        });
                    } else {
                         const initialMessage = `Welcome back, I'm ${buddyName}! Your session is ready. What's on your mind?`;
                         appendMessage(initialMessage, buddyName);
                    }

                    showSection(chatSection);

                } else if (response.status === 404) {
                    buddyNameInput.value = '';
                    personalityInput.value = '';
                    buddyName = "Buddy";
                    idealFriendCharacteristics = "";
                    showSection(personalitySection);

                } else {
                    console.error(`Error fetching history: ${data.detail || response.statusText}.`);
                    showSection(personalitySection); 
                }

            } catch (error) {
                console.error('Error loading chat history (network or parsing failure):', error);
                showSection(personalitySection); 
            }
        }
        
        async function handleLogout() {
            if (!accessToken) {
                console.log("No token found. Client-side logout complete.");
                showSection(authSection);
                return;
            }
            try {
                const response = await fetch('/api/logout', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${accessToken}` },
                });

                if (response.ok) {
                    console.log('Server-side token revocation successful.');
                }
                
            } catch (error) {
                console.error('Error during server-side logout, proceeding with client-side cleanup:', error);
            } finally {
                accessToken = null;
                buddyName = "Buddy";
                idealFriendCharacteristics = "";
                chatContainer.innerHTML = '';
                showSection(authSection);
                alert('You have been logged out.');
            }
        }

        personalityForm.addEventListener('submit', async function(event) {
            event.preventDefault();
            idealFriendCharacteristics = personalityInput.value.trim();
            const name = buddyNameInput.value.trim() || "Buddy";
        
            if (idealFriendCharacteristics === '') {
                personalityInput.style.borderColor = '#EF4444';
                return;
            }
            
            chatContainer.innerHTML = '';
            buddyName = name;
            buddyNameDisplay.textContent = buddyName;
            showSection(chatSection);
        
            const initialMessage = `Alright, ${buddyName} here! Based on the personality you described, I'm ready to become your friend. What's on your mind?`;
            appendMessage(initialMessage, buddyName);
        });

        chatForm.addEventListener('submit', async function(event) {
            event.preventDefault();
            const userMessage = chatInput.value.trim();
            if (userMessage === '') return;

            appendMessage(userMessage, 'You');
            chatInput.value = '';

            try {
                if (!accessToken) {
                    throw new Error("Authentication token is missing. Please log in again.");
                }

                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`,
                    },
                    body: JSON.stringify({
                        message: userMessage,
                        ideal_friend: idealFriendCharacteristics , 
                        buddy_name: buddyName
                    }),
                });
                
                const data = await response.json();

                if (!response.ok) {
                    const errorMessage = data.detail || `HTTP error! status: ${response.status}`;
                    throw new Error(errorMessage);
                }

                appendMessage(data.response, buddyName);

            } catch (error) {
                console.error('Error fetching chat response:', error);
                const displayMessage = error.message.includes("token is missing") || error.message.includes("Invalid authentication token") 
                    ? "Session expired or token missing. Please log out and log back in."
                    : "Oops! Something went wrong. Try refreshing the page or checking your session.";
                
                appendMessage(displayMessage, buddyName);
            }
        });

        function appendMessage(text, sender, isHistory = false) {
            const messageWrapper = document.createElement('div');
            messageWrapper.classList.add('flex', 'flex-col', sender === 'You' ? 'items-end' : 'items-start', 'max-w-[75%]', sender === 'You' ? 'self-end' : 'self-start');

            const nameElement = document.createElement('div');
            nameElement.textContent = sender;
            nameElement.classList.add('text-gray-400', 'text-xs', 'mb-1', 'px-3', sender === 'You' ? 'text-right' : 'text-left');
            
            const messageBubble = document.createElement('div');
            messageBubble.classList.add('rounded-2xl', 'p-3', 'shadow-lg');

            if (sender === 'You') {
                messageBubble.classList.add('bg-indigo-600', 'text-white');
            } else {
                messageBubble.classList.add('bg-purple-600', 'text-white');
            }
            
        
            if (!isHistory) {
                 messageBubble.classList.add('animate-fadeInRight');
            }

            messageBubble.textContent = text;
            messageWrapper.appendChild(nameElement);
            messageWrapper.appendChild(messageBubble);
            chatContainer.appendChild(messageWrapper);

            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        showSection(authSection);
    }); 
</script>
</body>
</html>